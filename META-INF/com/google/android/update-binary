#!/sbin/sh
#Dynamic Installer by @BlassGO --- Also uses code from @osm0sis and @topjohnwu

#Basic functions
true() { return 0; }
false() { return 1; }
echo2() { >&2 echo "$@"; }
find_bin() { local IFS=":"; for path in $PATH; do [ -e "$path/$1" ] && echo "$path/$1" && break; done; }
ui_print() { while [ "$1" ]; do (! $BOOTMODE && [ -e "$OUTFD" ]) && echo -e "ui_print $1\nui_print" >> $OUTFD || echo "$1"; shift; done; }
defined() { while [ "$1" ]; do eval "[ -z \"\${${1}}\" ]" && return 1; shift; done; return 0; }
abort() { ui_print " " "$@" " "; exit 1; }
import_info() { ( echo >> "$l/info.txt"; cat "$1" >> "$l/info.txt"; rm -f "$1" ) 2>/dev/null; }
testrw() { local test return=0; for test; do if [ -d "$test" ]; then (rm -f "$test/.rw$$"; touch "$test/.rw$$" || echo > "$test/.rw$$") 2>/dev/null; if [ -f "$test/.rw$$" ]; then rm -f "$test/.rw$$"; else echo2 '!'"Read-Only: $test" && return=1; fi; else echo2 "Cant find: $test directory" && return=1; fi; done; return $return; }
ensure_dir() { while [ "$1" ]; do ( rm -rf "$1" ) 2>/dev/null; mkdir -p "$1"; [ ! -d "$1" ] && abort "ERROR: Cant create folder $1"; shift; done; }

#Advanced functions
is_substring() {
    case "$2" in
        *"$1"*) return 0 ;;
        *) return 1 ;;
    esac
}
get() {
  local args=$# skip=0 from to in get rm root
  while [ $args -gt 0 ]; do
    case $1 in
       -from)
       from="$2"
       skip=2;
       ;;
       -to)
       to="$2"
       skip=2;
       ;;
       -in)
       in="$2"
       skip=2;
       ;;
       *)
       set -- "$@" "$1"
       skip=1;
       ;;
    esac
    shift $skip; args=$(($args-$skip)); 
  done
  [ -z "$from" -o ! -f "$from" ] && abort "ERROR: Invalid ZIP: \"$from\""
  [ -z "$to" ] && to="$PWD"; to="${to%%/}/"
  [ -n "$in" ] && in="${in%%/}/"
  for get in "$@"; do
     root="${in}$get"
     echo2 "Getting: $get"
     unzip -qo "$from" "$root" -d "$to"
     if [ -f "${to}$root" ]; then
        mv -f "${to}$root" "${to}$get"
        chmod 755 "${to}$get"
        if [ -f "${to}$get" ]; then
           rm=${root%%/*}
           [ "$rm" != "$root" -a -d "${to}$rm" ] && rm -rf "${to}$rm"
        else abort "ERROR:2: Cant get $get"
        fi
     else abort "ERROR:1: Cant get $get"
     fi
  done
}
ensure_bin() {
   local path bin
   [ -z "$bb" ] && bb=$(find_bin busybox)
   while [ "$1" ]; do
      bin=
      if [ ! -e "$(command -v "$1")" ]; then
         bin=$(find_bin $1); [ -n "$bin" ] && bin="\"$bin\""
         if [ -z "$bin" -a -n "$bb" ] && "$bb" --list | "$bb" grep -Eq "^$1$"; then bin="\"$bb\" $1"; fi
         [ -n "$bin" ] && eval "$1() { $bin \"\$@\"; }"
         ($needed && [ -z "$bin" ]) && abort "ERROR: Could not define \"$1\" binary"
      fi
      shift;
   done
}
bbForArch() {
   local bbpath
   export ARCH
   (rm -f $bb) 2>/dev/null;
   for ARCH in arm64-v8a armeabi-v7a; do
       bbpath=$TMP/META-INF/zbin/arch/$ARCH/busybox
       (unzip -qo "$installzip" "META-INF/zbin/arch/$ARCH/busybox" -d $TMP; chmod 755 $bbpath) 2>/dev/null
       if [ -x $bbpath ] && $bbpath >/dev/null 2>&1; then
         echo2 "ARCH: $ARCH"
         mv -f $bbpath $bb
         break
       fi
   done
   [ -f "$bb" ] && (rm -rf $TMP/META-INF) 2>/dev/null || abort "ERROR: Unsupported device architecture!"
}
setup_bb() {
   #Try to ensure /system/bin/sh
   needed=false; ensure_bin umount ln
   if [ ! -f /system/bin/sh ]; then
      umount -l /system 2>/dev/null
      mkdir -p /system/bin
      ln -sf "$(command -v sh)" /system/bin/sh
   fi
   if [ -e "$bb" ]; then
     if ! echo "read me" | "$bb" grep -q "read me"; then
        abort "ERROR:4: BusyBox cannot load on this device!"
     elif ! "$bb" --install -s "$l"; then
        for i in $("$bb" --list); do
          if ! ln -sf "$bb" "$l/$i" && ! "$bb" ln -sf "$bb" "$l/$i" && ! "$bb" ln -f "$bb" "$l/$i"; then
            # create script wrapper if symlinking and hardlinking failed because of restrictive selinux policy
            if ! echo "#!$bb" > "$l/$i" || ! chmod 755 "$l/$i"; then
              abort "ERROR:2: Failed to setup BusyBox"
            fi
          fi
        done
     fi
   else
      abort "ERROR:1: Cant find BusyBox"
   fi
   [ ! -f "$l/sh" ] && abort "ERROR:3: Failed to setup BusyBox"
}
setup() {
  #Ensure work DIRs
  ensure_dir "$l"
  
  #Ensure BusyBox for ARCH
  bb="$TMP/zbin/busybox"; bbForArch
  
  #Remove only zbin plugins
  ( rm -f "$TMP/bin" "$TMP/extra.zip" "$TMP/core" "$TMP/static") 2>/dev/null
  
  #Extracting bin for ARCH
  get bin -from "$installzip" -in "META-INF/zbin/arch/$ARCH" -to "$TMP"
  
  #Extracting core & static
  get core static -from "$installzip" -in "META-INF/zbin" -to "$TMP"
  
  #Ensure BusyBox Environment
  setup_bb; export PATH="$l:$PATH"
  
  #Extracting extra.zip (Optional)
  is_substring extra.zip "$(unzip -l "$installzip" META-INF/addons/extra.zip)" && get extra.zip -from "$installzip" -in "META-INF/addons" -to "$TMP"
  
  #Loading bin & static
  for bin in bin static; do
     unzip -qo "$TMP/$bin" -d "$TMP/zbin"
     import_info "$TMP/zbin/info.txt"
  done
  
  #Loading extra.zip (Optional)
  if [ -f "$TMP/extra.zip" ]; then
     if is_substring $ARCH "$(unzip -l "$TMP/extra.zip" "$ARCH/")"; then
        unzip -qoj "$TMP/extra.zip" "$ARCH/*" -d "$TMP/zbin"
        import_info "$TMP/zbin/info.txt"
     else
        echo2 "setup: extra.zip does not include additions to your architecture"
     fi
  fi
  
  #Start Installation
  find "$TMP/zbin" -type f ! -name "busybox" -exec mv -f {} "$l" \;
  find "$l" -type f -exec chmod 755 {} +;
  mv -f "$TMP/core" "$TMP/zbin/core"
  find "$TMP" -mindepth 1 -maxdepth 1 -type f -delete > /dev/null
  PATH="$PATH:/system/bin" bash "$TMP/zbin/core" "$@"
  [ $? == 130 ] && exit 1 || exit 0
}

#Get BOOTMODE and OUTFD
ps | grep zygote | grep -qv grep && export BOOTMODE=true || export BOOTMODE=false
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -qv grep && export BOOTMODE=true
[ -n "$2" -a -e "/proc/self/fd/$2" ] && export OUTFD="/proc/self/fd/$2"

#Start
umask 022
unsupport=false
export PATH="/sbin:/system/bin:/sbin/su:/su/bin:/su/xbin:/system/xbin:/data/adb/magisk:/data/adb/ksu/bin:/data/adb/ap/bin:$PATH"
needed=true; ensure_bin unzip mkdir chmod mv
needed=false; ensure_bin rm

#Ensure Temp directory
for TMP in /dev/tmp$$ /cache/tmp$$ /mnt/tmp$$ /data/tmp$$ /data/local/tmp$$; do
    mkdir -p $TMP 2>/dev/null; testrw $TMP && break || TMP=
done
[ -n "$TMP" ] && export TMP || abort "ERROR: Failed to create temporary directory"

#Global vars
[ -f "$3" ] && export installzip="$3" ZIPFILE="$3" PERSISTDIR=/sbin/.magisk/mirror/persist || export installzip="$ZIPFILE" CUSTOM_SETUP=2
export TMPDIR="$TMP" \
DNM="META-INF/com/google/android/magisk" \
cert="META-INF/zbin/version.txt" \
addons="$TMP/zbin/addons" \
l="$TMP/zbin/ugu"

setup "$@"